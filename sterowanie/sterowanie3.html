<!DOCTYPE html>
<html lang="pl">
  <head>
    <script src="axios.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sterowanie</title>
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <link rel="stylesheet" href="sterowanie.css">
    <link rel="icon" type="image/x-icon" href="icon.png" />
  </head>
  <body>
    <h1 style="font-size: 18pt">Sterowanie urządzeniami - 3 piętro</h1>

    <div
      style="display: flex; flex-direction: row; gap: 15px; align-items: center"
    ></div>
    <div id="myDiv" class="main_image">
      <img src="swiatla-bg.png">
      <a onmousedown="wyslijTrue('l3_1_1')" style="cursor: pointer">
        <img id="wyj_l3_1_1" class="zarowka"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 25%; left: 17%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_1"
        style="position: absolute; top: 21%; left: 19%"
      >
        35 *C
      </div>
      <a onmousedown="wyslijTrue('l3_1_2')" style="cursor: pointer">
        <img
          id="wyj_l3_1_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 25%; left: 22%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_2_1')" style="cursor: pointer">
        <img
          id="wyj_l3_2_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 29%; left: 53%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_2"
        style="position: absolute; top: 24%; left: 54%"
      >
        25 *C
      </div>
      <a onmousedown="wyslijTrue('l3_2_2')" style="cursor: pointer">
        <img
          id="wyj_l3_2_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 29%; left: 58%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_3_1')" style="cursor: pointer">
        <img
          id="wyj_l3_3_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 29%; left: 71%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_3"
        style="position: absolute; top: 24%; left: 73%"
      >
        17 *C
      </div>
      <a onmousedown="wyslijTrue('l3_3_2')" style="cursor: pointer">
        <img
          id="wyj_l3_3_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 29%; left: 76%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_4_1')" style="cursor: pointer">
        <img
          id="wyj_l3_4_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 71%; left: 17%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_4"
        style="position: absolute; top: 65%; left: 18%"
      >
        22 *C
      </div>
      <img
        id="b3_r4_1"
        src="arrow.png"
        style="width: 3%; position: absolute; top: 81%; left: 20%"
        onmousedown="roletaWlacz('b3_r4_1')"
      />
      <img
        id="b3_r4_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 25%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b3_r4_2')"
      />
      <a onmousedown="wyslijTrue('l3_4_2')" style="cursor: pointer">
        <img
          id="wyj_l3_4_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 71%; left: 22%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_5_1')" style="cursor: pointer">
        <img
          id="wyj_l3_5_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 37%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_5"
        style="position: absolute; top: 62%; left: 39%"
      >
        19 *C
      </div>
      <img
        id="b3_r4_1"
        src="arrow.png"
        style="width: 3%; position: absolute; top: 81%; left: 39%"
        onmousedown="roletaWlacz('b3_r5_1')"
      />
      <img
        id="b3_r4_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 43%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b3_r5_2')"
      />
      <a onmousedown="wyslijTrue('l3_5_2')" style="cursor: pointer">
        <img
          id="wyj_l3_5_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 42%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_6_1')" style="cursor: pointer">
        <img
          id="wyj_l3_6_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 53%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_6"
        style="position: absolute; top: 62%; left: 55%"
      >
        27 *C
      </div>
      <img
        id="b3_r5_1"
        src="arrow.png"
        style="width: 3%; position: absolute; top: 81%; left: 55%"
        onmousedown="roletaWlacz('b3_r6_1')"
      />
      <img
        id="b3_r5_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 59%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b3_r6_2')"
      />
      <a onmousedown="wyslijTrue('l3_6_2')" style="cursor: pointer">
        <img
          id="wyj_l3_6_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 58%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_7_1')" style="cursor: pointer">
        <img
          id="wyj_l3_7_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 71%"
        />
      </a>
      <a onmousedown="wyslijTrue('l3_7_2')" style="cursor: pointer">
        <img
          id="wyj_l3_7_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 76%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_7"
        style="position: absolute; top: 62%; left: 73%"
      >
        20 *C
      </div>
      <img
        id="b3_r5_1"
        src="arrow.png"
        style="width: 3%; position: absolute; top: 81%; left: 72%"
        onmousedown="roletaWlacz('b3_r7_1')"
      />
      <img
        id="b3_r5_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 76%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b3_r7_2')"
      />
    </div>

    <script>
      let isFetchingLight = false;
      let isFetchingTemp = false;
      let isFetchingBlinds = false;
      let tempInterval, swiatloInterval;

      addEventListener("DOMContentLoaded", () => {
        pobierzDaneSwiatlo();
        pobierzDaneTemp();
        swiatloInterval = setInterval(pobierzDaneSwiatlo, 1000);
        tempInterval = setInterval(pobierzDaneTemp, 5100);
      });

      window.addEventListener("message", (event) => {
        if (event.data === "cleanup") {
          console.log("zatrzymywanie pobierania danych");
          clearInterval(tempInterval);
          clearInterval(swiatloInterval);
        }
      });

      async function pobierzDaneSwiatlo() {
        if (isFetchingLight) return;
        isFetchingLight = true;

        try {
          const response = await axios.get(
            "http://localhost:3000/swiatla/3/wyjscia"
          );
          const dane = response.data;
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(id);
            if (el) {
              el.src = wartosc ? "bulb_on.png" : "bulb_of.png";
            }
          });
        } catch (err) {
          console.error("Błąd pobierania danych o świetle:", err);
        } finally {
          isFetchingLight = false;
        }
      }

      async function pobierzDaneTemp() {
        if (isFetchingTemp) return;
        isFetchingTemp = true;

        try {
          const response = await axios.get(
            "http://localhost:3000/temperatura/3"
          );
          const dane = response.data;
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(id);
            if (el) {
              if(wartosc) {
                el.innerText = `${wartosc} °C`;
              }
              
            }
          });
        } catch (err) {
          console.error("Błąd pobierania danych o temperaturze:", err);
        } finally {
          isFetchingTemp = false;
        }
      }

      async function wyslijTrue(swiatlo) {
        if (isFetchingLight) return;
        isFetchingLight = true;

        try {
          // Najpierw wł.
          await axios.put(`http://localhost:3000/swiatla/3/${swiatlo}`, {
            wartosc: true,
          });
          // Następnie wył.
          await axios.put(`http://localhost:3000/swiatla/3/${swiatlo}`, {
            wartosc: false,
          });
          // Odśwież stan
          await pobierzDaneSwiatlo();
        } catch (err) {
          console.error("Błąd wysyłania sygnału:", err);
        } finally {
          isFetchingLight = false;
        }
      }
      /*async function roletkaWlacz(roleta) {
        if (isFetchingBlinds) return;
        isFetchingBlinds = true;

        try {
          // 1. Pobierz aktualny stan rolety
          const getRes = await axios.get(
            `http://localhost:3000/rolety/3/wyjscia/${roleta}`
          );
          const { wartosc } = getRes.data;
          console.log("Stan przed zmianą rolety:", wartosc);

          // 2. Ustal nową wartość (przełącz)
          const nowaWartosc = !wartosc;

          // 3. Wyślij PUT z przełączoną wartością
          const putRes = await axios.put(
            `http://localhost:3000/rolety/3/${roleta}`,
            { wartosc: nowaWartosc }
          );
          console.log("Odpowiedź po zmianie rolety:", putRes.data);
        } catch (err) {
          console.error("Błąd przy obsłudze rolety:", err);
        } finally {
          isFetchingBlinds = false;
        }
      }*/
    </script>
  </body>
</html>
