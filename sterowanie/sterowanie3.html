<!DOCTYPE html>
<html lang="pl">
  <head>
    <script src="axios.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sterowanie</title>
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <link rel="stylesheet" href="sterowanie.css" />
    <link rel="icon" type="image/x-icon" href="icon.png" />
  </head>
  <body>
    <h1 style="font-size: 18pt">Sterowanie urządzeniami - 3 piętro</h1>

    <div
      style="display: flex; flex-direction: row; gap: 15px; align-items: center"
    ></div>
        <div id="myDiv" class="main_image">
      <img src="swiatla-bg.png" id="main_image">
      <a onmousedown="" style="cursor: pointer">
        <img id="all_l3" class="wszystkieSwiatla" src="btn_on.png"/>
        <!-- Przycisk do wszystkich świateł -->
      </a>
      <a onmousedown="wyslijTrue('l3_1_1')" style="cursor: pointer">
        <img id="wyj_l3_1_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t3_1">
        35 *C
      </div>
      <a onmousedown="wyslijTrue('l3_1_2')" style="cursor: pointer">
        <img id="wyj_l3_1_2" class="zarowka"  src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l3_2_1')" style="cursor: pointer">
        <img id="wyj_l3_2_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t3_2">
        25 *C
      </div>
      <a onmousedown="wyslijTrue('l3_2_2')" style="cursor: pointer">
        <img id="wyj_l3_2_2" class="zarowka" src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l3_3_1')" style="cursor: pointer">
        <img id="wyj_l3_3_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t3_3">
        17 *C
      </div>
      <a onmousedown="wyslijTrue('l3_3_2')" style="cursor: pointer">
        <img id="wyj_l3_3_2" class="zarowka" src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l3_4_1')" style="cursor: pointer">
        <img id="wyj_l3_4_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t3_4">
        22 *C
      </div>
      <img id="b3_r4_1" class="strzalka" src="arrow.png"
        onmousedown="roletaWlacz('b3_r4_1')"
      />
      <img id="b3_r4_2" class="strzalka odwrot" src="arrow.png"
        onmousedown="roletaWlacz('b3_r4_2')"
      />
      <a onmousedown="wyslijTrue('l3_4_2')" style="cursor: pointer">
        <img id="wyj_l3_4_2" class="zarowka"  src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l3_5_1')" style="cursor: pointer">
        <img id="wyj_l3_5_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t3_5">
        19 *C
      </div>
      <img
        id="b3_r5_1" class="strzalka" src="arrow.png"
        onmousedown="roletaWlacz('b3_r5_1')"
      />
      <img id="b3_r5_2" class="strzalka odwrot" src="arrow.png"
        onmousedown="roletaWlacz('b3_r5_2')"
      />
      <a onmousedown="wyslijTrue('l3_5_2')" style="cursor: pointer">
        <img id="wyj_l3_5_2" class="zarowka" src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l3_6_1')" style="cursor: pointer">
        <img id="wyj_l3_6_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t3_6">
        27 *C
      </div>
      <img id="b3_r6_1" class="strzalka" src="arrow.png"
        onmousedown="roletaWlacz('b3_r6_1')"
      />
      <img id="b3_r6_2" class="strzalka odwrot" src="arrow.png"
        onmousedown="roletaWlacz('b3_r6_2')"
      />
      <a onmousedown="wyslijTrue('l3_6_2')" style="cursor: pointer">
        <img id="wyj_l3_6_2" class="zarowka" src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l3_7_1')" style="cursor: pointer">
        <img id="wyj_l3_7_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <a onmousedown="wyslijTrue('l3_7_2')" style="cursor: pointer">
        <img id="wyj_l3_7_2" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t3_7">
        20 *C
      </div>
      <img id="b3_r7_1" class="strzalka" src="arrow.png"
        onmousedown="roletaWlacz('b3_r7_1')"
      />
      <img id="b3_r7_2" class="strzalka odwrot" src="arrow.png"
        onmousedown="roletaWlacz('b3_r7_2')"
      />
    </div>

    <script>
      let isFetchingLight = false;
      let isFetchingTemp = false;
      let fetchingBlinds = false;
      let tempInterval, swiatloInterval;

      addEventListener("DOMContentLoaded", () => {
        pobierzDaneSwiatlo();
        pobierzDaneTemp();
        swiatloInterval = setInterval(pobierzDaneSwiatlo, 200);
        tempInterval = setInterval(pobierzDaneTemp, 200);
      });

      window.addEventListener("message", (event) => {
        if (event.data === "cleanup") {
          console.log("zatrzymywanie pobierania danych");
          clearInterval(tempInterval);
          clearInterval(swiatloInterval);
        }
      });

      async function pobierzDaneSwiatlo() {
        if (isFetchingLight) return;
        isFetchingLight = true;

        try {
          const response = await axios.get(
            "http://localhost:3000/swiatla/3/wyjscia"
          );
          const dane = response.data;
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(id);
            if (el) {
              el.src = wartosc ? "bulb_on.png" : "bulb_of.png";
            }
          });
        } catch (err) {
          console.error("Błąd pobierania danych o świetle:", err);
        } finally {
          isFetchingLight = false;
        }
      }

      async function pobierzDaneTemp() {
        if (isFetchingTemp) return;
        isFetchingTemp = true;

        try {
          const response = await axios.get(
            "http://localhost:3000/temperatura/3"
          );
          const dane = response.data;
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(id);
            if (el) {
              if (wartosc) {
                el.innerText = `${Math.round(wartosc * 100) / 100} °C`;
              }
            }
          });
        } catch (err) {
          console.error("Błąd pobierania danych o temperaturze:", err);
        } finally {
          isFetchingTemp = false;
        }
      }

      async function wyslijTrue(swiatlo) {
        if (isFetchingLight) return;
        isFetchingLight = true;

        try {
          // Najpierw wł.
          await axios.put(`http://localhost:3000/swiatla/3/${swiatlo}`, {
            wartosc: true,
          });
          // Następnie wył.
          await axios.put(`http://localhost:3000/swiatla/3/${swiatlo}`, {
            wartosc: false,
          });
          // Odśwież stan
          //await pobierzDaneSwiatlo();
        } catch (err) {
          console.error("Błąd wysyłania sygnału:", err);
        } finally {
          isFetchingLight = false;
        }
      }
      /*async function roletkaWlacz(roleta) {
        if (isFetchingBlinds) return;
        isFetchingBlinds = true;

        try {
          // 1. Pobierz aktualny stan rolety
          const getRes = await axios.get(
            `http://localhost:3000/rolety/3/wyjscia/${roleta}`
          );
          const { wartosc } = getRes.data;
          console.log("Stan przed zmianą rolety:", wartosc);

          // 2. Ustal nową wartość (przełącz)
          const nowaWartosc = !wartosc;

          // 3. Wyślij PUT z przełączoną wartością
          const putRes = await axios.put(
            `http://localhost:3000/rolety/3/${roleta}`,
            { wartosc: nowaWartosc }
          );
          console.log("Odpowiedź po zmianie rolety:", putRes.data);
        } catch (err) {
          console.error("Błąd przy obsłudze rolety:", err);
        } finally {
          isFetchingBlinds = false;
        }
      }*/
    </script>
  </body>
</html>
