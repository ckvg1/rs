<!DOCTYPE html>
<html lang="pl">
  <head>
    <script src="axios.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sterowanie</title>
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <link rel="stylesheet" href="sterowanie.css" />
    <link rel="icon" type="image/x-icon" href="icon.png" />
  </head>
  <body>
    <h1 style="font-size: 18pt">Sterowanie urządzeniami - 3 piętro</h1>

    <div
      style="display: flex; flex-direction: row; gap: 15px; align-items: center"
    ></div>
        <div id="myDiv" class="main_image">
      <img src="swiatla-bg.png" id="main_image">
      <a onmousedown="" style="cursor: pointer">
        <img id="all_l3" class="wszystkieSwiatla" src="btn_on.png"/>
        <!-- Przycisk do wszystkich świateł -->
      </a>
      <a onmousedown="wyslijTrue('l3_1_1')" style="cursor: pointer">
        <img id="wyj_l3_1_1" class="zarowka" src="bulb_on.png " />
      </a>
      <div class="temperatura" id="t3_1">35 *C</div>
      <a onmousedown="wyslijTrue('l3_1_2')" style="cursor: pointer">
        <img id="wyj_l3_1_2" class="zarowka" src="bulb_on.png " />
      </a>

      <a onmousedown="wyslijTrue('l3_2_1')" style="cursor: pointer">
        <img id="wyj_l3_2_1" class="zarowka" src="bulb_on.png " />
      </a>
      <div class="temperatura" id="t3_2">25 *C</div>
      <a onmousedown="wyslijTrue('l3_2_2')" style="cursor: pointer">
        <img id="wyj_l3_2_2" class="zarowka" src="bulb_on.png " />
      </a>

      <a onmousedown="wyslijTrue('l3_3_1')" style="cursor: pointer">
        <img id="wyj_l3_3_1" class="zarowka" src="bulb_on.png " />
      </a>
      <div class="temperatura" id="t3_3">17 *C</div>
      <a onmousedown="wyslijTrue('l3_3_2')" style="cursor: pointer">
        <img id="wyj_l3_3_2" class="zarowka" src="bulb_on.png " />
      </a>

      <a onmousedown="wyslijTrue('l3_4_1')" style="cursor: pointer">
        <img id="wyj_l3_4_1" class="zarowka" src="bulb_on.png " />
      </a>
      <div class="temperatura" id="t3_4">22 *C</div>
      <img
        id="b3_r4_1"
        class="strzalka"
        src="arrow.png"
        onmousedown="roletaWlacz('b3_r4_1')"
      />
      <img
        id="b3_r4_2"
        class="strzalka odwrot"
        src="arrow.png"
        onmousedown="roletaWlacz('b3_r4_2')"
      />
      <a onmousedown="wyslijTrue('l3_4_2')" style="cursor: pointer">
        <img id="wyj_l3_4_2" class="zarowka" src="bulb_on.png " />
      </a>

      <a onmousedown="wyslijTrue('l3_5_1')" style="cursor: pointer">
        <img id="wyj_l3_5_1" class="zarowka" src="bulb_on.png " />
      </a>
      <div class="temperatura" id="t3_5">19 *C</div>
      <img
        id="b3_r5_1"
        class="strzalka"
        src="arrow.png"
        onmousedown="roletaWlacz('b3_r5_1')"
      />
      <img
        id="b3_r5_2"
        class="strzalka odwrot"
        src="arrow.png"
        onmousedown="roletaWlacz('b3_r5_2')"
      />
      <a onmousedown="wyslijTrue('l3_5_2')" style="cursor: pointer">
        <img id="wyj_l3_5_2" class="zarowka" src="bulb_on.png " />
      </a>

      <a onmousedown="wyslijTrue('l3_6_1')" style="cursor: pointer">
        <img id="wyj_l3_6_1" class="zarowka" src="bulb_on.png " />
      </a>
      <div class="temperatura" id="t3_6">27 *C</div>
      <img
        id="b3_r6_1"
        class="strzalka"
        src="arrow.png"
        onmousedown="roletaWlacz('b3_r6_1')"
      />
      <img
        id="b3_r6_2"
        class="strzalka odwrot"
        src="arrow.png"
        onmousedown="roletaWlacz('b3_r6_2')"
      />
      <a onmousedown="wyslijTrue('l3_6_2')" style="cursor: pointer">
        <img id="wyj_l3_6_2" class="zarowka" src="bulb_on.png " />
      </a>

      <a onmousedown="wyslijTrue('l3_7_1')" style="cursor: pointer">
        <img id="wyj_l3_7_1" class="zarowka" src="bulb_on.png " />
      </a>
      <a onmousedown="wyslijTrue('l3_7_2')" style="cursor: pointer">
        <img id="wyj_l3_7_2" class="zarowka" src="bulb_on.png " />
      </a>
      <div class="temperatura" id="t3_7">20 *C</div>
      <img
        id="b3_r7_1"
        class="strzalka"
        src="arrow.png"
        onmousedown="roletaWlacz('b3_r7_1')"
      />
      <img
        id="b3_r7_2"
        class="strzalka odwrot"
        src="arrow.png"
        onmousedown="roletaWlacz('b3_r7_2')"
      />
    </div>

    <script>
      let isFetchingLight = false;
      let isFetchingTemp = false;
      let fetchingBlinds = false;
      let tempInterval, swiatloInterval;

      addEventListener("DOMContentLoaded", () => {
        const swiatlaStream = new EventSource(
          "http://localhost:3000/stream/swiatla"
        );
        swiatlaStream.onmessage = (event) => {
          const dane = JSON.parse(event.data);
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(id);
            if (el) {
              if (el.id[0] == "w") {
                el.src = wartosc ? "bulb_on.png" : "bulb_of.png";
              }
            }
          });
        };

        const temperaturaStream = new EventSource(
          "http://localhost:3000/stream/temperatura"
        );
        temperaturaStream.onmessage = (event) => {
          const dane = JSON.parse(event.data);
          console.log(dane);
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(id);
            if (el) el.innerText = `${wartosc.toFixed(1)} °C`;
          });
        };

        const roletyStream = new EventSource(
          "http://localhost:3000/stream/rolety"
        );
        roletyStream.onmessage = (event) => {
          const dane = JSON.parse(event.data);
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(
              id.split("_")[1] + "_" + id.split("_")[2] + "_" + id.split("_")[3]
            );
            if (el) {
              el.src = wartosc ? "arrow.png" : "arrow_of.png";
            }
          });
        };
      });

      async function wyslijTrue(swiatlo) {
        if (isFetchingLight) return;
        isFetchingLight = true;
        try {
          // Najpierw wł.
          await axios.put(`http://localhost:3000/swiatla/3/${swiatlo}`, {
            wartosc: true,
          });
          // Następnie wył.
          await axios.put(`http://localhost:3000/swiatla/3/${swiatlo}`, {
            wartosc: false,
          });
        } catch (err) {
          console.error("Błąd wysyłania sygnału:", err);
        } finally {
          isFetchingLight = false;
        }
      }

      async function roletaWlacz(roleta) {
        if (fetchingBlinds) return;
        fetchingBlinds = true;
        try {
          await axios.put(`http://localhost:3000/rolety/3/${roleta}`, {
            wartosc: true,
          });
          await axios.put(`http://localhost:3000/rolety/3/${roleta}`, {
            wartosc: false,
          });
        } catch (err) {
          console.error("Błąd wysyłania sygnału do rolet:", err);
        } finally {
          fetchingBlinds = false;
        }
      }
    </script>
  </body>
</html>
