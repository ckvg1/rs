<!DOCTYPE html>
<html lang="pl">
  <head>
    <script src="axios.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sterowanie</title>
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <link rel="icon" type="image/x-icon" href="icon.png" />
    <style>
      body {
        font-family: "Courier New", Courier, monospace;
        background-color: #d3e2ec;
      }

      button {
        background-color: #2a80f9;
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
      }
      .temperatura {
        font-weight: bold;
        font-size: 16pt;
      }
    </style>
  </head>
  <body
    style="
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 0px;
      font-family: 'Ubuntu';
    "
  >
    <h1 style="font-size: 18pt">Sterowanie urządzeniami - 3 piętro</h1>

    <div
      style="display: flex; flex-direction: row; gap: 15px; align-items: center"
    ></div>
    <div
      id="myDiv"
      class="main_image"
      style="
        width: 1118px;
        height: 745px;
        background-image: url('swiatla-bg.png');
        position: relative;
      "
    >
      <a onmousedown="wyslijTrue('l3_1_1')" style="cursor: pointer">
        <img
          id="wyj_l3_1_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 25%; left: 17%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_1"
        style="position: absolute; top: 21%; left: 19%"
      >
        35 *C
      </div>
      <a onmousedown="wyslijTrue('l3_1_2')" style="cursor: pointer">
        <img
          id="wyj_l3_1_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 25%; left: 22%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_2_1')" style="cursor: pointer">
        <img
          id="wyj_l3_2_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 29%; left: 53%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_2"
        style="position: absolute; top: 24%; left: 54%"
      >
        25 *C
      </div>
      <a onmousedown="wyslijTrue('l3_2_2')" style="cursor: pointer">
        <img
          id="wyj_l3_2_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 29%; left: 58%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_3_1')" style="cursor: pointer">
        <img
          id="wyj_l3_3_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 29%; left: 71%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_3"
        style="position: absolute; top: 24%; left: 73%"
      >
        17 *C
      </div>
      <a onmousedown="wyslijTrue('l3_3_2')" style="cursor: pointer">
        <img
          id="wyj_l3_3_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 29%; left: 76%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_4_1')" style="cursor: pointer">
        <img
          id="wyj_l3_4_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 71%; left: 17%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_4"
        style="position: absolute; top: 65%; left: 18%"
      >
        22 *C
      </div>
      <img
        id="b3_r4_1"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 20%;
          background-color: red;
        "
        onmousedown="roletaWlacz('b3_r4_1')"
      />
      <img
        id="b3_r4_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 25%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b3_r4_2')"
      />
      <a onmousedown="wyslijTrue('l3_4_2')" style="cursor: pointer">
        <img
          id="wyj_l3_4_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 71%; left: 22%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_5_1')" style="cursor: pointer">
        <img
          id="wyj_l3_5_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 37%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_5"
        style="position: absolute; top: 62%; left: 39%"
      >
        19 *C
      </div>
      <a onmousedown="wyslijTrue('l3_5_2')" style="cursor: pointer">
        <img
          id="wyj_l3_5_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 42%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_6_1')" style="cursor: pointer">
        <img
          id="wyj_l3_6_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 53%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_6"
        style="position: absolute; top: 62%; left: 55%"
      >
        27 *C
      </div>
      <a onmousedown="wyslijTrue('l3_6_2')" style="cursor: pointer">
        <img
          id="wyj_l3_6_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 58%"
        />
      </a>

      <a onmousedown="wyslijTrue('l3_7_1')" style="cursor: pointer">
        <img
          id="wyj_l3_7_1"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 71%"
        />
      </a>
      <a onmousedown="wyslijTrue('l3_7_2')" style="cursor: pointer">
        <img
          id="wyj_l3_7_2"
          src="bulb_on.png "
          style="width: 4%; position: absolute; top: 68%; left: 76%"
        />
      </a>
      <div
        class="temperatura"
        id="t3_7"
        style="position: absolute; top: 62%; left: 73%"
      >
        20 *C
      </div>
    </div>

    <script>
      //const axios = require("axios/dist/browser/axios.cjs");
      let tempInterval, swiatloInterval;
      addEventListener("DOMContentLoaded", () => {
        // start interwałów
        pobierzDaneSwiatlo();
        pobierzDaneTemp();
        //pobierzDaneTemp();
        swiatloInterval = setInterval(pobierzDaneSwiatlo, 100);
        tempInterval = setInterval(pobierzDaneTemp, 5000);
      });

      window.addEventListener("message", (event) => {
        if (event.data === "cleanup") {
          console.log("zatrzymywanie pobierania danych");
          clearInterval(tempInterval);
          clearInterval(swiatloInterval);
          // możesz też anulować fetch z AbortController, jeśli chcesz
        }
      });

      function pobierzDaneSwiatlo() {
        axios
          .get("http://localhost:3000/swiatla/3/wyjscia")
          .then((response) => {
            const dane = response.data;
            //console.log(Object.entries(dane));
            Object.entries(dane).forEach(([id, wartosc]) => {
              //  console.log("Dane o swiatle:", id, wartosc);
              const przycisk = document.getElementById(id);
              if (przycisk) {
                //console.log(przycisk);
                przycisk.setAttribute(
                  "src",
                  wartosc ? "bulb_on.png" : "bulb_of.png"
                );
              } else {
                console.log("nie ma takiego przycisku ", przycisk);
              }
            });
          })
          .then(() => {})
          .catch((error) => {
            console.error("Błąd pobierania danych o swiatlach:", error);
          });
      }
      function pobierzDaneTemp() {
        axios
          .get("http://localhost:3000/temperatura/3")
          .then((response) => {
            const dane = response.data;
            console.log("Pobrano dane o temperaturze:", response);
            Object.entries(dane).forEach(([id, wartosc]) => {
              const przycisk = document.getElementById(id);
              if (przycisk) {
                przycisk.innerHTML = `${wartosc.toFixed(1)} *C`;
              } else {
                console.log("Nie ma takiego diva z temperatura lol", id);
              }
            });
          })
          .catch((error) => {
            console.error("Blad pobierania danych o temperaturze", error);
          });
      }
      function wyslijTrue(swiatlo) {
        axios
          .put(`http://localhost:3000/swiatla/3/${swiatlo}`, {
            wartosc: true,
          })
          .then((response) => {
            // console.log("Odpowiedź:", response.data);
          })
          .then(() => {
            axios
              .put(`http://localhost:3000/swiatla/3/${swiatlo}`, {
                wartosc: false,
              })
              .then((response) => {
                //console.log("Odpowiedź:", response.data);
                pobierzDaneSwiatlo();
              })
              .catch((error) => {
                console.error("Błąd:", error);
              });
          })
          .catch((error) => {
            console.error("Błąd:", error);
          });
      }

      function roletaWlacz(roleta) {
        axios
          .get(`http://localhost:3000/rolety/3/wyjscia/${roleta}`)
          .then((response) => {
            console.log("Stan przed wlaczeniem rolety:", response.data);
            if (response.data.wartosc === false) {
              //jezeli roleta nie jedzie to wysylamy true a jak jedzie to false zeby ja zatrzymac
              axios
                .put(`http://localhost:3000/rolety/3/${roleta}`, {
                  wartosc: true,
                })
                .then((response) => {
                  console.log(
                    "Odpowiedź po kliknieciu roleta gora:",
                    response.data
                  );
                });
            } else {
              console.log("Roleta już jedzie");
              axios
                .put(`http://localhost:3000/rolety/3/${roleta}`, {
                  wartosc: false,
                })
                .then((response) => {
                  console.log(
                    "Odpowiedź po kliknieciu roleta gora:",
                    response.data
                  );
                });
            }
          });
      }

      //function wyslijFalse(swiatlo) {}
    </script>
  </body>
</html>
