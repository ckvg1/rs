<!DOCTYPE html>
<html lang="pl">
  <head>
    <script src="axios.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sterowanie</title>
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <link rel="stylesheet" href="sterowanie.css">
    <link rel="icon" type="image/x-icon" href="icon.png" />
  </head>
  <body>
    <h1 style="font-size: 18pt">Sterowanie urządzeniami - 2 piętro</h1>

    <div
      style="display: flex; flex-direction: row; gap: 15px; align-items: center"
    ></div>
    <div id="myDiv" class="main_image">
      <img src="swiatla-bg.png" id="main_image">
      <a onmousedown="wyslijTrue('l2_1_1')" style="cursor: pointer">
        <img id="wyj_l2_1_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t2_1">
        35 *C
      </div>
      <a onmousedown="wyslijTrue('l2_1_2')" style="cursor: pointer">
        <img id="wyj_l2_1_2" class="zarowka"  src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l2_2_1')" style="cursor: pointer">
        <img id="wyj_l2_2_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t2_2">
        25 *C
      </div>
      <a onmousedown="wyslijTrue('l2_2_2')" style="cursor: pointer">
        <img id="wyj_l2_2_2" class="zarowka" src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l2_3_1')" style="cursor: pointer">
        <img id="wyj_l2_3_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t2_3">
        17 *C
      </div>
      <a onmousedown="wyslijTrue('l2_3_2')" style="cursor: pointer">
        <img id="wyj_l2_3_2" class="zarowka" src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l2_4_1')" style="cursor: pointer">
        <img id="wyj_l2_4_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t2_4">
        22 *C
      </div>
      <img
        id="b2_r4_1"
        src="arrow.png"
        style="width: 3%; position: absolute; top: 81%; left: 20%"
        onmousedown="roletaWlacz('b2_r4_1')"
      />
      <img
        id="b2_r4_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 25%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b2_r4_2')"
      />
      <a onmousedown="wyslijTrue('l2_4_2')" style="cursor: pointer">
        <img id="wyj_l2_4_2" class="zarowka"  src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l2_5_1')" style="cursor: pointer">
        <img id="wyj_l2_5_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t2_5">
        19 *C
      </div>
      <img
        id="b2_r4_1"
        src="arrow.png"
        style="width: 3%; position: absolute; top: 81%; left: 39%"
        onmousedown="roletaWlacz('b2_r5_1')"
      />
      <img
        id="b2_r4_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 43%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b2_r5_2')"
      />
      <a onmousedown="wyslijTrue('l2_5_2')" style="cursor: pointer">
        <img id="wyj_l2_5_2" class="zarowka" src="bulb_on.png "/>
      </a>

      <a onmousedown="wyslijTrue('l2_6_1')" style="cursor: pointer">
        <img id="wyj_l2_6_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t2_6">
        27 *C
      </div>
      <img
        id="b2_r5_1"
        src="arrow.png"
        style="width: 3%; position: absolute; top: 81%; left: 55%"
        onmousedown="roletaWlacz('b2_r6_1')"
      />
      <img
        id="b2_r5_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 59%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b2_r6_2')"
      />
      <a onmousedown="wyslijTrue('l2_6_2')" style="cursor: pointer">
        <img
          id="wyj_l2_6_2" class="zarowka"
          src="bulb_on.png "
          style="top: 68%; left: 58%"
        />
      </a>

      <a onmousedown="wyslijTrue('l2_7_1')" style="cursor: pointer">
        <img id="wyj_l2_7_1" class="zarowka" src="bulb_on.png "/>
      </a>
      <a onmousedown="wyslijTrue('l2_7_2')" style="cursor: pointer">
        <img id="wyj_l2_7_2" class="zarowka" src="bulb_on.png "/>
      </a>
      <div class="temperatura" id="t2_7">
        20 *C
      </div>
      <img
        id="b2_r5_1"
        src="arrow.png"
        style="width: 3%; position: absolute; top: 81%; left: 72%"
        onmousedown="roletaWlacz('b2_r7_1')"
      />
      <img
        id="b2_r5_2"
        src="arrow.png"
        style="
          width: 3%;
          position: absolute;
          top: 81%;
          left: 76%;
          transform: rotate(180deg);
        "
        onmousedown="roletaWlacz('b2_r7_2')"
      />
    </div>

    <script>
      //const axios = require("axios/dist/browser/axios.cjs");
      let tempInterval, swiatloInterval;
      addEventListener("DOMContentLoaded", () => {
        // start interwałów
        pobierzDaneSwiatlo();
        pobierzDaneTemp();
        //pobierzDaneTemp();
        swiatloInterval = setInterval(pobierzDaneSwiatlo, 100);
        tempInterval = setInterval(pobierzDaneTemp, 5000);
      });

      window.addEventListener("message", (event) => {
        if (event.data === "cleanup") {
          console.log("zatrzymywanie pobierania danych");
          clearInterval(tempInterval);
          clearInterval(swiatloInterval);
          // możesz też anulować fetch z AbortController, jeśli chcesz
        }
      });

      function pobierzDaneSwiatlo() {
        axios
          .get("http://localhost:3000/swiatla/2/wyjscia")
          .then((response) => {
            const dane = response.data;
            //console.log(Object.entries(dane));
            Object.entries(dane).forEach(([id, wartosc]) => {
              //  console.log("Dane o swiatle:", id, wartosc);
              const przycisk = document.getElementById(id);
              if (przycisk) {
                //console.log(przycisk);
                przycisk.setAttribute(
                  "src",
                  wartosc ? "bulb_on.png" : "bulb_of.png"
                );
              } else {
                console.log("nie ma takiego przycisku ", przycisk);
              }
            });
          })
          .then(() => {})
          .catch((error) => {
            console.error("Błąd pobierania danych o swiatlach:", error);
          });
      }
      function pobierzDaneTemp() {
        axios
          .get("http://localhost:3000/temperatura/2")
          .then((response) => {
            const dane = response.data;
            console.log("Pobrano dane o temperaturze:", response);
            Object.entries(dane).forEach(([id, wartosc]) => {
              const przycisk = document.getElementById(id);
              if (przycisk) {
                przycisk.innerHTML = `${wartosc.toFixed(1)} *C`;
              } else {
                console.log("Nie ma takiego diva z temperatura", id);
              }
            });
          })
          .catch((error) => {
            console.error("Blad pobierania danych o temperaturze", error);
          });
      }
      function wyslijTrue(swiatlo) {
        axios
          .put(`http://localhost:3000/swiatla/2/${swiatlo}`, {
            wartosc: true,
          })
          .then((response) => {
            // console.log("Odpowiedź:", response.data);
          })
          .then(() => {
            axios
              .put(`http://localhost:3000/swiatla/2/${swiatlo}`, {
                wartosc: false,
              })
              .then((response) => {
                //console.log("Odpowiedź:", response.data);
                pobierzDaneSwiatlo();
              })
              .catch((error) => {
                console.error("Błąd:", error);
              });
          })
          .catch((error) => {
            console.error("Błąd:", error);
          });
      }

      function roletaWlacz(roleta) {
        axios
          .get(`http://localhost:3000/rolety/2/wyjscia/${roleta}`)
          .then((response) => {
            console.log("Stan przed wlaczeniem rolety:", response.data);
            if (response.data.wartosc === false) {
              //jezeli roleta nie jedzie to wysylamy true a jak jedzie to false zeby ja zatrzymac
              axios
                .put(`http://localhost:3000/rolety/2/${roleta}`, {
                  wartosc: true,
                })
                .then((response) => {
                  console.log(
                    "Odpowiedź po kliknieciu roleta gora:",
                    response.data
                  );
                });
            } else {
              console.log("Roleta już jedzie");
              axios
                .put(`http://localhost:3000/rolety/2/${roleta}`, {
                  wartosc: false,
                })
                .then((response) => {
                  console.log(
                    "Odpowiedź po kliknieciu roleta gora:",
                    response.data
                  );
                });
            }
          });
      }

      //function wyslijFalse(swiatlo) {}
    </script>
  </body>
</html>
