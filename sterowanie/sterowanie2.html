<!DOCTYPE html>
<html lang="pl">
  <head>
    <script src="axios.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sterowanie</title>
    <link rel="stylesheet" href="../css_main/glowny.css" />
    <link rel="stylesheet" href="../css_main/sterowanie.css" />
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <link rel="icon" type="image/x-icon" href="../img_main/icon.png" />
    <script src="../config.js"></script>
    <script src="../js/translations.js"></script>
  </head>
  <body>
    <h1 style="font-size: 18pt">Sterowanie urządzeniami - 2 piętro</h1>
    <div id="alertBox" class="oaerror danger" style="display: none"></div>
    <div
      style="display: flex; flex-direction: row; gap: 15px; align-items: center"
    ></div>
    <div id="myDiv" class="main_image">
      <img src="../img_main/mapy/sterowanie-bg.png" id="main_image" />
      <a onmousedown="wyslijTrue('all_OFF_l2')" style="cursor: pointer">
        <img
          id="all_l2"
          class="wszystkieSwiatla"
          src="../img_main/icony/btn_of.png"
        />

        <!-- Przycisk do wszystkich świateł -->
      </a>
      <a onmousedown="wyslijTrue('all_ON_l2')" style="cursor: pointer">
        <img
          style="margin-left: 5%"
          id="all_l2"
          class="wszystkieSwiatla"
          src="../img_main/icony/btn_on.png"
        />

        <!-- Przycisk do wszystkich świateł -->
      </a>
      <div class="blokZarowki" id="blokZarowki2_1">
        <a onmousedown="wyslijTrue('l2_1_1')" style="cursor: pointer">
          <img
            id="wyj_l2_1_1"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
        <a onmousedown="wyslijTrue('l2_1_2')" style="cursor: pointer">
          <img
            id="wyj_l2_1_2"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
      </div>
      <div class="temperatura" id="t2_1">Błąd odczytu</div>
      <div class="nazwaBiura" id="nazwa2_1"></div>

      <div class="blokZarowki" id="blokZarowki2_2">
        <a onmousedown="wyslijTrue('l2_2_1')" style="cursor: pointer">
          <img
            id="wyj_l2_2_1"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>

        <a onmousedown="wyslijTrue('l2_2_2')" style="cursor: pointer">
          <img
            id="wyj_l2_2_2"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
      </div>
      <div class="temperatura" id="t2_2">Błąd odczytu</div>
      <div class="nazwaBiura" id="nazwa2_2"></div>

      <div class="blokZarowki" id="blokZarowki2_3">
        <a onmousedown="wyslijTrue('l2_3_1')" style="cursor: pointer">
          <img
            id="wyj_l2_3_1"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
        <a onmousedown="wyslijTrue('l2_3_2')" style="cursor: pointer">
          <img
            id="wyj_l2_3_2"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
      </div>
      <div class="temperatura" id="t2_3">Błąd odczytu</div>
      <div class="nazwaBiura" id="nazwa2_3"></div>

      <div class="blokZarowki" id="blokZarowki2_4">
        <a onmousedown="wyslijTrue('l2_4_1')" style="cursor: pointer">
          <img
            id="wyj_l2_4_1"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
        <a onmousedown="wyslijTrue('l2_4_2')" style="cursor: pointer">
          <img
            id="wyj_l2_4_2"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
      </div>
      <div class="blokRolety" id="blokRolety2_4">
        <img
          id="b2_r4_1"
          class="strzalka"
          src="../img_main/icony/arrow.png"
          onmousedown="roletaWlacz('b2_r4_1')"
        />
        <img
          id="b2_r4_2"
          class="strzalka odwrot"
          src="../img_main/icony/arrow.png"
          onmousedown="roletaWlacz('b2_r4_2')"
        />
      </div>
      <div class="temperatura" id="t2_4">Błąd odczytu</div>
      <div class="nazwaBiura" id="nazwa2_4"></div>

      <div class="blokZarowki" id="blokZarowki2_5">
        <a onmousedown="wyslijTrue('l2_5_1')" style="cursor: pointer">
          <img
            id="wyj_l2_5_1"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
        <a onmousedown="wyslijTrue('l2_5_2')" style="cursor: pointer">
          <img
            id="wyj_l2_5_2"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
      </div>
      <div class="blokRolety" id="blokRolety2_5">
        <img
          id="b2_r5_1"
          class="strzalka"
          src="../img_main/icony/arrow.png"
          onmousedown="roletaWlacz('b2_r5_1')"
        />
        <img
          id="b2_r5_2"
          class="strzalka odwrot"
          src="../img_main/icony/arrow.png"
          onmousedown="roletaWlacz('b2_r5_2')"
        />
      </div>
      <div class="temperatura" id="t2_5">Błąd odczytu</div>
      <div class="nazwaBiura" id="nazwa2_5"></div>

      <div class="blokZarowki" id="blokZarowki2_6">
        <a onmousedown="wyslijTrue('l2_6_1')" style="cursor: pointer">
          <img
            id="wyj_l2_6_1"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
        <a onmousedown="wyslijTrue('l2_6_2')" style="cursor: pointer">
          <img
            id="wyj_l2_6_2"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
      </div>
      <div class="blokRolety" id="blokRolety2_6">
        <img
          id="b2_r6_1"
          class="strzalka"
          src="../img_main/icony/arrow.png"
          onmousedown="roletaWlacz('b2_r6_1')"
        />
        <img
          id="b2_r6_2"
          class="strzalka odwrot"
          src="../img_main/icony/arrow.png"
          onmousedown="roletaWlacz('b2_r6_2')"
        />
      </div>
      <div class="temperatura" id="t2_6">Błąd odczytu</div>
      <div class="nazwaBiura" id="nazwa2_6"></div>

      <div class="blokZarowki" id="blokZarowki2_7">
        <a onmousedown="wyslijTrue('l2_7_1')" style="cursor: pointer">
          <img
            id="wyj_l2_7_1"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
        <a onmousedown="wyslijTrue('l2_7_2')" style="cursor: pointer">
          <img
            id="wyj_l2_7_2"
            class="zarowka"
            src="../img_main/icony/bulb_on.png "
          />
        </a>
      </div>
      <div class="blokRolety" id="blokRolety2_7">
        <img
          id="b2_r7_1"
          class="strzalka"
          src="../img_main/icony/arrow.png"
          onmousedown="roletaWlacz('b2_r7_1')"
        />
        <img
          id="b2_r7_2"
          class="strzalka odwrot"
          src="../img_main/icony/arrow.png"
          onmousedown="roletaWlacz('b2_r7_2')"
        />
      </div>
      <div class="temperatura" id="t2_7">Błąd odczytu</div>
      <div class="nazwaBiura" id="nazwa2_7"></div>
    </div>
    <script>
      //Skrypt do ustawiania nazw z cookies
      const nazwyDivy = document.querySelectorAll(".nazwaBiura");

      nazwyDivy.forEach((div) => {
        const id = div.id.replace("nazwa", "");
        const cookie = getCookie("pietro2");
        if (!cookie) {
          console.log("Ciasteczko nie istnieje!");
        }
        const parsedCookie = JSON.parse(cookie);
        // console.log("Parsed cookie:", parsedCookie);
        //console.log("ID: ", id);
        if (cookie) {
          div.innerText = parsedCookie["r" + id];
        } else {
          div.innerText = "Brak nazwy";
        }
      });
    </script>
    <script>
      const alertBox = document.getElementById("alertBox");

      let isFetchingLight = false;
      let isFetchingBlinds = false;

      function reconnectStreams() {
        location.reload(); // odświeżenie strony w celu ponownego nawiązania połączenia z serwerem
      }

      function showAlert(
        message = "<strong>Uwaga</strong> - Błąd połączenia z PLC. <img src='" +
          no_internet +
          "' style='width: 20px; height: 20px; vertical-align: middle;' /> <a onclick='reconnectStreams()' style='cursor: pointer; margin-left: 20px'> <strong style='color: black'> spróbuj ponownie </strong> </a>"
      ) {
        if (document.body.classList.contains("ciemny")) {
          no_internet = "../img_main/icony/no-internet-dark.png";
        } else {
          no_internet = "../img_main/icony/no-internet.png";
        }
        alertBox.style.display = "block";
        document.querySelector(".oaerror").innerHTML = message;
        translatePage(getCookie("lang") || "pl");
      }
      function hideAlert() {
        alertBox.style.display = "none";
      }
      addEventListener("DOMContentLoaded", () => {
        showAlert(
          " Trwa łączenie z PLC. <img src='../img_main/icony/loading.gif' style='width: 30px; height: 30px; vertical-align: middle; margin-left: 10px' />"
        );
        const connectionTimeout = setTimeout(() => {
          showAlert();
        }, 10000);
        const swiatlaStream = new EventSource(
          `${window.config.apiBaseUrl}/stream/swiatla`
        );
        swiatlaStream.onmessage = (event) => {
          clearTimeout(connectionTimeout);
          const dane = JSON.parse(event.data);
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(id);
            if (el) {
              if (el.id[0] == "w") {
                el.src = wartosc
                  ? "../img_main/icony/bulb_on.png"
                  : "../img_main/icony/bulb_of.png";
              }
            }
          });
        };
        const temperaturaStream = new EventSource(
          `${window.config.apiBaseUrl}/stream/temperatura`
        );
        temperaturaStream.onmessage = (event) => {
          clearTimeout(connectionTimeout);
          const dane = JSON.parse(event.data);
          console.log(dane);
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(id);
            if (el) el.innerText = `${wartosc.toFixed(1)} °C`;
          });
        };

        const roletyStream = new EventSource(
          `${window.config.apiBaseUrl}/stream/rolety`
        );
        roletyStream.onmessage = (event) => {
          clearTimeout(connectionTimeout);
          const dane = JSON.parse(event.data);
          Object.entries(dane).forEach(([id, wartosc]) => {
            const el = document.getElementById(
              id.split("_")[1] + "_" + id.split("_")[2] + "_" + id.split("_")[3]
            );
            if (el) {
              el.src = wartosc
                ? "../img_main/icony/arrow.png"
                : "../img_main/icony/arrow_of.png";
            }
          });
        };
        roletyStream.onerror = (err) => {
          showAlert();
          console.error("Błąd połączenia z serwerem rolety:", err);
        };
        temperaturaStream.onerror = (err) => {
          showAlert();
          console.error("Błąd połączenia z serwerem temperatury:", err);
        };
        swiatlaStream.onerror = (err) => {
          showAlert();
          console.error("Błąd połączenia z serwerem świateł:", err);
        };
        roletyStream.onopen = () => {
          hideAlert();
          console.log("Połączono z serwerem rolety");
        };
        temperaturaStream.onopen = () => {
          hideAlert();
          console.log("Połączono z serwerem temperatury");
        };
        swiatlaStream.onopen = () => {
          hideAlert();
          console.log("Połączono z serwerem świateł");
        };
      });

      async function wyslijTrue(swiatlo) {
        if (isFetchingLight) return;
        isFetchingLight = true;
        try {
          // Najpierw wł.
          await axios.put(`${window.config.apiBaseUrl}/swiatla/${swiatlo}`, {
            wartosc: true,
          });
          // Następnie wył.

          await axios.put(`${window.config.apiBaseUrl}/swiatla/${swiatlo}`, {
            wartosc: false,
          });
        } catch (err) {
          alertBox.style.display = "block";
          showAlert();
        } finally {
          isFetchingLight = false;
        }
      }

      async function roletaWlacz(roleta) {
        if (isFetchingBlinds) return;
        isFetchingBlinds = true;
        try {
          await axios.put(`${window.config.apiBaseUrl}/rolety/${roleta}`, {
            wartosc: true,
          });
          await axios.put(`${window.config.apiBaseUrl}/rolety/${roleta}`, {
            wartosc: false,
          });
        } catch (err) {
          showAlert();
          console.error("Błąd wysyłania sygnału do rolet:", err);
        } finally {
          isFetchingBlinds = false;
        }
      }
    </script>
    <script src="../js/dark_mode.js"></script>
    <script>
      main_image = document.getElementById("main_image");
      if (document.body.classList.contains("ciemny")) {
        main_image.src = "../img_main/mapy/sterowanie-bg-dark.png";
      }
    </script>
  </body>
</html>
