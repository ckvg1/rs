<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Temperatura</title>
    <link rel="icon" type="image/x-icon" href="icon.png" />
    <link rel="stylesheet" href="../css_main/glowny.css" />
    <link rel="stylesheet" href="css/temperatura.css" />
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <script src="js/plotly.min.js" charset="utf-8"></script>
  </head>
  <body>
    <div class="container">
      <!-- <header>
        <img src="../logo.svg" alt="Logo" />
      </header> -->

      <h1>Data wykonania pomiaru (od-do):</h1>
      <h4 id="zakresDat">Używam danych z: Ostatnie 24 godziny</h4>

      <div class="form-group" id="formularz">
        <input type="datetime-local" id="data1" />
        -
        <input type="datetime-local" id="data2" />
        <select onchange="ustaw_pietro()" id="pietroSelect">
          <option value="1">Piętro 1</option>
          <option value="2">Piętro 2</option>
          <option value="3" selected>Piętro 3</option>
        </select>
        <button class="przycisk" id="filtrujBtn">Filtruj</button>
        
        <input type="checkbox" id="switch" /> 
        <label for="switch">Toggle</label>
        <!-- <button id="markersBtn">Wykres kropkowy</button>
        <button id="linesBtn">Wykres liniowy</button> -->

        
      </div>
      <!-- domyslnie ukryty, pokazuje sie jak nie bedzie danych -->
      <div id="alertBox" class="oaerror danger" style="display: none">
        <strong>Error</strong>- You need to remember your username/password.
        Please try again.
      </div>

      <div id="myPlot" style="width: 100%"></div>
    </div>

    <script>
      "use strict";

      let currentMode = "markers"; // tryb wykresu: markers / lines
      let pietro = "3"; // domyślne piętro
      // Funkcja do ustawienia piętra na podstawie wyboru użytkownika
      function ustaw_pietro() {
        const select = document.getElementById("pietroSelect");
        pietro = select.value;
        console.log("Wybrane piętro:", pietro);
      }

      const zakresDat = document.getElementById("zakresDat");
      const filtrujBtn = document.getElementById("filtrujBtn");

      // Formatowanie daty do czytelnej postaci
      function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        return `${day}-${month}-${year} ${hours}:${minutes}`;
      }
      function getCookie(name) {
          let cname = name + "=";
          let decodedCookie = decodeURIComponent(document.cookie);
          let ca = decodedCookie.split(';');
          for(let i = 0; i < ca.length; i++) {
            let c = ca[i].trim();
            if (c.indexOf(cname) == 0) {
              return c.substring(cname.length, c.length);
            }
          }
          return "";
        }

        let cookie = getCookie("pietro" + pietro);
        let parsedCookie = JSON.parse(cookie);
        const bazoweBiura = [
          "1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
        ];
        function generujNazwyBiur(pietro) {
          return bazoweBiura.map((id) => `r${pietro}_${id}`);
        }
      // Pobieranie danych i rysowanie wykresu
      function fetchAndPlot(url, layoutOverrides = {}) {
        const nazwyBiur = generujNazwyBiur(pietro);
        
        fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Błąd HTTP! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((dane) => {
            //console.log("Dane do wykresu:", dane);
            const seriesData = [];
            //console.log("Parsed cookie:", parsedCookie);
            const nazwy = nazwyBiur.map(key => parsedCookie[key] || key);
            //console.log("Nazwy biur:", nazwyBiur); 
            console.log("Nazwy biur pobrane z cookie:", nazwy);
            for (let i = 1; i <= 8; i++) {
              //lecimy do 7 bo tyle czujnikow
              
              
              const key = `Temp. ${pietro}_${i}`;
              if (dane[key]) {
                seriesData.push({
                  x: dane.Data,
                  y: dane[key],
                  mode: currentMode,
                  name: nazwy[i - 1] || key, // używamy nazwy z cookie lub domyślnej
                  line: { shape: "spline" }, //vh - schodkowe
                });
              }
              if (i == 8) {
                seriesData.push({
                  x: dane.Data,
                  y: dane["Temp. zewn"],
                  mode: currentMode,
                  name: `Temp. zewn`,
                  line: { shape: "spline" }, //vh
                });
              }
            }

            // Przekształć na wykres schodkowy jeśli tryb to "lines"
            if (currentMode === "lines") {
              //zrobWykresSchodkowy(seriesData[0]);
            }

            const defaultLayout = {
              bgcolor: "rgb(211, 226, 236)", // tło całego wykresu
              bgcolor: "rgb(211, 226, 236)", // tło obszaru wykresu
              height: 650,
              title: "Temperatura",
              xaxis: {
                type: "date",
                title: "Data wykonania pomiaru",
              },
              yaxis: {
                title: "Temperatura [C]",
              },
              showlegend: true,
            };

            const layout = Object.assign({}, defaultLayout, layoutOverrides);

            let alertBox = document.getElementById("alertBox");
            if (dane[`Temp. ${pietro}_1`].length == 0) {
              alertBox.style.display = "block";
              alertBox.innerHTML =
                "<strong>Uwaga</strong> - Brak danych do wyświetlenia wykresu. Proszę podać daty pomiaru.";
            } else {
              alertBox.style.display = "none";
            }

            Plotly.newPlot("myPlot", seriesData, layout, {
              scrollZoom: true,

              responsive: true,
            });
          })
          .catch((error) => console.error("Error fetching data:", error));
      }
      function toLocalISOString(date = new Date()) {
        const pad = (num) => String(num).padStart(2, "0");

        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hour = pad(date.getHours());
        const minute = pad(date.getMinutes());
        const second = pad(date.getSeconds());
        return `${year}-${month}-${day}T${hour}:${minute}:${second}`;
      }
      // Obsługa przycisku "Filtruj"
      function filtruj() {
        const dateInput1 = document.getElementById("data1").value;
        const dateInput2 = document.getElementById("data2").value;

        if (dateInput1 && dateInput2) {
          const data1 = new Date(dateInput1).toISOString();
          const data2 = new Date(dateInput2).toISOString();
          zakresDat.innerHTML = `Używam danych z: ${formatDate(
            data1
          )} - ${formatDate(data2)}`;
          console.log(data1, data2);
          const url = `odczytaj_dane.php?data_od=${toLocalISOString(
            new Date(data1)
          )}&data_do=${toLocalISOString(new Date(data2))}&pietro=${pietro}`;
          console.log(url);
          fetchAndPlot(url);
        } else if (!dateInput1 && !dateInput2) {
          zakresDat.innerHTML = "Używam danych z: Ostatnie 24 godziny";
          fetchAndPlot(`odczytaj_dane.php?pietro=${pietro}`);
        } else {
          alert("Wybierz obie daty pomiaru!");
        }
      }

      // Zdarzenia
      filtrujBtn.addEventListener("click", filtruj);
      document.getElementById("switch").addEventListener("change", (e) => {
        currentMode = e.target.checked ? "lines" : "markers";
        filtruj(); // Przeładuj wykres po zmianie trybu
      });
      

      // Załaduj wykres domyślny
      fetchAndPlot(`odczytaj_dane.php?pietro=${pietro}`);
    </script>
  </body>
</html>
