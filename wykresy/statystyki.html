<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Statystyki</title>
    <link rel="icon" type="image/x-icon" href="../img_main/icon.png" />
    <link rel="stylesheet" href="../css_main/glowny.css" />
    <link rel="stylesheet" href="../css_main/statystyki.css" />
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <script src="../sterowanie/axios.min.js"></script>
    <script src="../js/translations.js"></script>
    <script src="../js/load_translation.js"></script>
  </head>
  <body>
    <div
      id="alertBox"
      class="oaerror danger"
      style="
        display: none;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
      "
      title="Za błędne dane skrypt uznaje czujniki, które wpisują do bazy wartość 0, 99, mniejszą niż 0 lub NULL."
    >
      <!-- text ustawiam w js. alertbox domyslnie schowany pokazuje sie jak skrypt wysle ze sa bledne dane w bazie -->
    </div>
    <div class="flex_div">
      <section id="statystykiTemperatura">
        <h1>
          Temperatura
          <select id="temperaturaCzasSelect">
            <option value="1">24h</option>
            <option value="2">7 dni</option>
            <option value="3">30 dni</option>
          </select>
        </h1>
        <div>
          <select id="temperaturaPietroSelect">
            <option value="1">Piętro 1</option>
            <option value="2">Piętro 2</option>
            <option value="3">Piętro 3</option>
          </select>
        </div>
        <div
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
          "
        >
          <div class="icons_div">
            <img
              title="Maksymalna temperatura w budynku (1 odczyt)"
              src="../img_main/icony/temp_high.png"
            />
            <img
              title="Średnia temperatura w budynku"
              src="../img_main/icony/chart.png"
            />
            <img
              title="Minimalna temperatura w budynku (1 odczyt)"
              src="../img_main/icony/temp_low.png"
            />
            <img
              title="Średnia temperatura na zewnątrz"
              src="../img_main/icony/outdoor.png"
            />
          </div>
          <div class="stats_div">
            <p
              title="Maksymalna temperatura w budynku (1 odczyt)"
              id="najwyzszaTemperatura"
            ></p>
            <p
              title="Średnia temperatura w budynku"
              id="sredniaTemperatura"
            ></p>
            <p
              title="Minimalna temperatura w budynku (1 odczyt)"
              id="najnizszaTemperatura"
            ></p>
            <p
              title="Średnia temperatura na zewnątrz"
              id="sredniaTemperaturaZewnetrzna"
            ></p>
          </div>
        </div>
      </section>

      <section id="statystykiSwiatla">
        <h1>
          Światło
          <select id="czasSwiatloSelect">
            <option value="1">24h</option>
            <option value="2">7 dni</option>
            <option value="3">30 dni</option>
          </select>
        </h1>

        <div>
          <select id="swiatloPietroSelect">
            <option selected value="1">Piętro 1</option>
            <option value="2">Piętro 2</option>
            <option value="3">Piętro 3</option>
          </select>
        </div>
        <div
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
          "
        >
          <div class="icons_div">
            <img
              title="Najczęściej włączane światło"
              src="../img_main/icony/light_on.png"
              id="light_on"
            />

            <img
              title="Najczęściej wyłączone światło"
              src="../img_main/icony/light_off.png"
              id="light_off"
            />
            <img
              title="Godzina o której świeci się najwięcej świateł"
              src="../img_main/icony/clock.png"
              id="clock"
            />
            <img
              title="Czas, w którym światło było włączone"
              src="../img_main/icony/hourglass.png"
            />
          </div>
          <div class="stats_div">
            <p title="Najczęściej włączane światło" id="najwyzszeSwiatlo"></p>

            <p title="Najczęściej wyłączone światło" id="najnizszeSwiatlo"></p>
            <p
              title="Godzina o której świeci się najwięcej świateł"
              id="godzinaNajwiecejSwiatla"
            ></p>
            <p
              title="Czas, w którym światło było włączone"
              id="swiatloWlaczoneCzas"
            ></p>
          </div>
        </div>
      </section>

      <section>
        <h1>Włącz wszystkie światła</h1>
        <h1>w firmie</h1>
        <a
          onmousedown="wlaczWszstkieSwiatla()"
          style="cursor: pointer; margin: 25%"
        >
          <img
            style="margin: auto; width: 50%"
            id="all_l1"
            class="wszystkieSwiatla"
            src="../img_main/icony/btn_on.png"
          />

          <!-- Przycisk do wszystkich świateł -->
        </a>
        <script>
          let isFetchingLight = false;

          async function wlaczWszstkieSwiatla() {
            //wyslijTrue("all_ON_l1");
            await wyslijTrue("all_ON_l2");
            await wyslijTrue("all_ON_l3");
          }
          async function wylaczWszystkieSwiatla() {
            //wyslijTrue("all_OFF_l1");
            await wyslijTrue("all_OFF_l2");
            await wyslijTrue("all_OFF_l3");
          }
          async function ustawHarmonogram(harmonogram = null) {
            if (harmonogram === null) {
              const godzinaInput = document.getElementById(
                `harmonogramGodzinaInput`
              );
              const godzina = godzinaInput.value;
              harmonogram = {
                all_OFF_l3: `${godzina}`,
                all_OFF_l2: `${godzina}`,
              };
              await axios.put(
                `http://192.168.25.59:3000/harmonogram/add`,
                harmonogram
              );
            } else {
              await axios.put(
                `http://192.168.25.59:3000/harmonogram/add`,

                harmonogram
              );
            }
          }
          async function wyslijTrue(swiatlo) {
            if (isFetchingLight) return;
            isFetchingLight = true;
            try {
              // Najpierw wł.
              await axios.put(`http://192.168.25.59:3000/swiatla/${swiatlo}`, {
                wartosc: true,
              });
              // Następnie wył.
              await axios.put(`http://192.168.25.59:3000/swiatla/${swiatlo}`, {
                wartosc: false,
              });
            } catch (err) {
              console.error("Błąd wysyłania sygnału:", err);
            } finally {
              isFetchingLight = false;
            }
          }
        </script>
      </section>
      <section id="raporty">
        <h1>Raporty</h1>
        <select id="raportySelect" style="margin: 10px">
          <option value="1">1 piętro</option>
          <option value="2">2 piętro</option>
          <option value="3">3 piętro</option>
          <option selected value="4">Wszystkie piętra</option>
        </select>
        <button class="przycisk" id="pobierzRaportTemperaturyButton">
          Pobierz miesięczny raport temperatury
        </button>
        <button class="przycisk" id="pobierzRaportSwiatlaButton">
          Pobierz miesięczny raport światła
        </button>

        <script>
          const raportySelect = document.getElementById("raportySelect");
          let pietro = 4;
          // aktualizacja etykiet
          raportySelect.addEventListener("change", () => {
            pietro = raportySelect.value;
            const postfix = pietro != 4 ? ` - Piętro ${pietro}` : "";

            const buttons = [
              { id: "pobierzRaportTemperaturyButton", label: "temperatury" },
              { id: "pobierzRaportSwiatlaButton", label: "światła" },
            ];

            buttons.forEach(({ id, label }) => {
              document.getElementById(
                id
              ).innerText = `Pobierz miesięczny raport ${label}${postfix}`;
            });
            translatePage(getCookie("lang") || "pl");
          });

          // pobieranie raportów
          document
            .getElementById("pobierzRaportTemperaturyButton")
            .addEventListener("click", () => {
              const pietro = raportySelect.value;
              window.location.href = `./php/generate_report.php?tabela=temperatura&pietro=${pietro}`;
            });

          document
            .getElementById("pobierzRaportSwiatlaButton")
            .addEventListener("click", () => {
              const pietro = raportySelect.value;
              window.location.href = `./php/generate_report.php?tabela=light&pietro=${pietro}`;
            });
        </script>
      </section>
      <section>
        <h1>Wyłącz wszystkie światła</h1>
        <h1>w firmie</h1>
        <a
          onmousedown="wylaczWszystkieSwiatla()"
          style="cursor: pointer; margin: 25%"
        >
          <img
            style="height: 50%"
            id="all_l1"
            class="wszystkieSwiatla"
            src="../img_main/icony/btn_of.png"
          />

          <!-- Przycisk do wszystkich świateł -->
        </a>
      </section>
      <section id="harmonogram">
        <h1>Harmonogram</h1>
        <div>
          <p>Wyłącz automatycznie wszystkie światła o:</p>
          <input id="harmonogramGodzinaInput" type="time" />

          <br />
          <br />
          <button type="button" onclick="ustawHarmonogram()" class="przycisk">
            Zapisz
          </button>
        </div>
      </section>
    </div>

    <script>
      const pietroTemperatura = document.querySelector(
        "#temperaturaPietroSelect"
      );
      let pietroTemperaturaValue = 1; // Domyślne piętro
      const temperaturaCzasSelect = document.querySelector(
        "#temperaturaCzasSelect"
      );

      const pietroSwiatla = document.querySelector("#swiatloPietroSelect");
      const czasWlaczoneSwiatlo = document.querySelector("#swiatloSelect");
      const czasSwiatloSelect = document.querySelector("#czasSwiatloSelect");
      let pietroSwiatlaValue = 1; // Domyślne piętro dla swiatla

      addEventListener("DOMContentLoaded", fetchStartData);

      function fetchStartData() {
        //fetchHarmonogramData();
        fetchTemperaturaData();
        fetchSwiatloData();
      }
      function fetchHarmonogramData() {
        axios.get("http://192.168.25.59:3000/harmonogram").then((response) => {
          const harmonogram = response.data;
          const godzinaInput = document.getElementById(
            "harmonogramGodzinaInput"
          );
          if (!harmonogram.godzinaOFF.isNaN()) {
            godzinaInput.value = harmonogram.godzinaOFF;
          }
        });
      }
      pietroTemperatura.addEventListener("change", fetchTemperaturaData);
      temperaturaCzasSelect.addEventListener("change", fetchTemperaturaData);

      //button do zamykania alertBox
      const button = document.createElement("button");
      button.innerText = "X";
      button.style.padding = "5px";
      button.title = "Zamknij";
      button.style.backgroundColor = "white";
      Object.assign(button.style, {
        color: "red",
        border: "none",
        cursor: "pointer",
      });

      button.onclick = () => {
        const date = new Date();
        date.setTime(date.getTime() + 24 * 60 * 60 * 1000); // dzisiaj + 1 dzien
        const expires = "expires=" + date.toUTCString();
        const alertBox = document.getElementById("alertBox");
        alertBox.style.display = "none";
        // ciasteczko zeby przegladarka pamietala ze alertbox wylaczony
        document.cookie = "alertBoxClosed=true; " + expires + "; path=/";
      };

      function getCookie(name) {
        let cname = name + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i].trim();
          if (c.indexOf(cname) == 0) {
            return c.substring(cname.length, c.length);
          }
        }
        return "";
      }

      function fetchTemperaturaData() {
        pietroTemperaturaValue = pietroTemperatura.value;
        const czasTemperatura = document.getElementById(
          "temperaturaCzasSelect"
        ).value;
        fetch(
          `./php/odczytaj_statystyki_temperatury.php?pietro=${pietroTemperaturaValue}&czas=${czasTemperatura}`
        )
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("najnizszaTemperatura").innerHTML =
              data.najmniejszaTemperatura +
              "℃ <span style='color:blue'>" +
              data.najnizszaTemperaturaCzujnik +
              "</span>";
            document.getElementById("sredniaTemperatura").innerHTML =
              data.sredniaTemperatura + "℃";
            document.getElementById("najwyzszaTemperatura").innerHTML =
              data.najwyzszaTemperatura +
              "℃ <span style='color:red'>" +
              data.najwyzszaTemperaturaCzujnik +
              "</span>";
            document.getElementById("sredniaTemperaturaZewnetrzna").innerHTML =
              data.sredniaZewnetrzna + "℃";

            if (
              data.bledneDane &&
              document.cookie.indexOf("alertBoxClosed=true") === -1
            ) {
              console.log("Błędne dane w bazie:", data.czujnikBledneDane);
              const alertBox = document.getElementById("alertBox");

              alertBox.innerHTML =
                "Prawdopodobne błędne dane w bazie. Czujniki: " +
                data.czujnikBledneDane.join(", ") +
                ". Błędne odczyty są ingorowane w statystykach.";
              alertBox.appendChild(button);
              alertBox.style.display = "flex";
            } else {
              const alertBox = document.getElementById("alertBox");
              alertBox.style.display = "none";
            }
            translatePage(getCookie("lang") || "pl");
          })
          .catch((error) => console.error("Błąd:", error));
      }

      pietroSwiatla.addEventListener("change", fetchSwiatloData);
      czasSwiatloSelect.addEventListener("change", fetchSwiatloData);

      function fetchSwiatloData() {
        pietroSwiatlaValue = pietroSwiatla.value;

        const czasSwiatlo = document.getElementById("czasSwiatloSelect").value;
        fetch(
          `./php/odczytaj_statystyki_swiatla.php?pietro=${pietroSwiatlaValue}&czas=${czasSwiatlo}`
        )
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("najwyzszeSwiatlo").innerHTML =
              "<span style='color: red'>" +
              data.najczesciejWlaczoneSwiatlo +
              "</span>";
            document.getElementById("najnizszeSwiatlo").innerHTML =
              "<span style='color: green'>" +
              data.najrzadziejWlaczoneSwiatlo +
              "</span>";
            document.getElementById("swiatloWlaczoneCzas").innerHTML =
              data.czasWlaczoneSwiatlo + " godz.";
            translatePage(getCookie("lang") || "pl");
          })
          .catch((error) => console.error("Błąd:", error));

        fetch(
          `./php/odczytaj_godzine.php?pietro=${pietroSwiatlaValue}&czas=${czasSwiatlo}`
        )
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("godzinaNajwiecejSwiatla").innerHTML =
              data.godzina;
          })
          .catch((error) => console.error("Błąd:", error));
      }
    </script>
    <script src="../js/dark_mode.js"></script>
    <script>
      light_off = document.getElementById("light_off");
      clock = document.getElementById("clock");

      if (document.body.classList.contains("ciemny")) {
        light_off.src = "../img_main/icony/light_off-dark.png";
        clock.src = "../img_main/icony/clock-dark.png";
      }
    </script>
  </body>
</html>
