<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Światła</title>
    <script src="js/heatmap.js"></script>
    <!-- -->
    <script src="js/plotly.min.js" charset="utf-8"></script>

    <link rel="icon" type="image/x-icon" href="icon.png" />
    <link rel="stylesheet" href="../css_main/glowny.css" />
    <link rel="stylesheet" href="css/swiatla.css" />
    <link rel="stylesheet" href="../css_main/czcionka.css" />
    <script src="../js/translations.js"></script>
  </head>
  <body class="jasny">
    <!-- <header><img src="../logo.svg" /></header> ! -->
    <h1 id="dataInfoText">Data wykonania pomiaru (od-do):</h1>
    <h4 id="zakresDat">Używam danych z: Ostatnie 24 godziny</h4>
    <div id="formularz">
      <input
        type="datetime-local"
        id="data1"
        placeholder="Wybierz datę pomiaru"
      />
      -
      <input
        type="datetime-local"
        id="data2"
        placeholder="Wybierz datę pomiaru"
      />
      <select onchange="ustaw_pietro()" id="pietroSelect">
        <option value="1">Piętro 1</option>
        <option value="2">Piętro 2</option>
        <option value="3" selected>Piętro 3</option>
      </select>
      <button class="przycisk" onclick="filtruj()">Filtruj</button>
    </div>
    <!-- Heatmap and Plotly Divs 
  myDiv is for the heatmap, myDiv2 is for additional content if needed (for mobile screen resolutions), and myPlot is for the Plotly graphs. 
 -->
    <div id="alertBox" class="oaerror danger" style="display: none"></div>
    <div id="myDiv" class="heatmap">
      <img id="mapa-swiatla" src="../wykresy/img/swiatla-bg.png">
    </div>
    <div id="myDiv2"></div>
    <div id="myPlot"></div>

    <script>
      "use strict";

      let pietro = 3;

      const bazoweCzujniki = [
        "1_1",
        "1_2",
        "2_1",
        "2_2",
        "3_1",
        "3_2",
        "4_1",
        "4_2",
        "5_1",
        "5_2",
        "6_1",
        "6_2",
        "7_1",
        "7_2",
      ];
      const bazoweBiura = ["1", "2", "3", "4", "5", "6"];

      function generujNazwyCzujnikow(pietro) {
        return bazoweCzujniki.map((id) => `l${pietro}_${id}`);
      }
      function generujNazwyBiur(pietro) {
        return bazoweBiura.map((id) => `r${pietro}_${id}`);
      }
      function ustaw_pietro() {
        pietro = document.getElementById("pietroSelect").value;
        console.log("Ustawiono piętro: ", pietro);
        console.log("Czujniki: ", generujNazwyCzujnikow(pietro));
      }

      const zakresDat = document.getElementById("zakresDat");

      document.addEventListener("DOMContentLoaded", function () {
        generujWykres(`odczytaj_swiatla.php?wszystko=true&pietro=${pietro}`);
        generujHeatmape(`odczytaj_swiatla.php?pietro=${pietro}`);
        generujWykresKolowy(`odczytaj_swiatla.php?pietro=${pietro}`);
      });
      let cookie = getCookie("pietro" + pietro);
      let parsedCookie = JSON.parse(cookie);
      function filtruj() {
        const data1 = document.getElementById("data1").value
          ? new Date(document.getElementById("data1").value).toISOString()
          : null;
        const data2 = document.getElementById("data2").value
          ? new Date(document.getElementById("data2").value).toISOString()
          : null;

        if (data1 && data2) {
          zakresDat.innerHTML = `Używam danych z: ${formatDate(
            data1
          )} - ${formatDate(data2)}`;
          generujHeatmape(
            `odczytaj_swiatla.php?od=${toLocalISOString(
              new Date(data1)
            )}&do=${toLocalISOString(new Date(data2))}&pietro=${pietro}`
          );
          generujWykres(
            `odczytaj_swiatla.php?od=${toLocalISOString(
              new Date(data1)
            )}&do=${toLocalISOString(
              new Date(data2)
            )}&wszystko=true&pietro=${pietro}`
          );
          generujWykresKolowy(
            `odczytaj_swiatla.php?od=${toLocalISOString(
              new Date(data1)
            )}&do=${toLocalISOString(new Date(data2))}&pietro=${pietro}`
          );
        } else {
          zakresDat.innerHTML = `Używam danych z: Ostatnie 24 godziny`;
          generujHeatmape(`odczytaj_swiatla.php?pietro=${pietro}`);
          generujWykres(`odczytaj_swiatla.php?wszystko=true&pietro=${pietro}`);
          generujWykresKolowy(`odczytaj_swiatla.php?pietro=${pietro}`);
        }
        cookie = getCookie("pietro" + pietro);
        parsedCookie = JSON.parse(cookie);
      }

      function formatDate(dateString) {
        if (!dateString) return "Brak daty";
        let date = new Date(dateString);
        return `${String(date.getDate()).padStart(2, "0")}-${String(
          date.getMonth() + 1
        ).padStart(2, "0")}-${date.getFullYear()} ${String(
          date.getHours()
        ).padStart(2, "0")}:${String(date.getMinutes()).padStart(2, "0")}`;
      }
      // Jezeli sa jakies dane to zwraca true, w przeciwnym razie false
      // Uzywane do sprawdzenia czy wykres kolowy ma byc wyswietlany
      function sprawdzCzySaDane(dane) {
        for (let i = 0; i < dane.length - 1; i++) {
          if (dane[i] !== 0) return true;
        }
        return false;
      }
      const alertBox = document.getElementById("alertBox");
      function generujWykresKolowy(endpoint) {
        fetch(endpoint)
          .then((res) => res.json())
          .then((dane) => {
            if (!sprawdzCzySaDane(Object.values(dane))) {
              alertBox.style.display = "block";
              document.querySelector(".oaerror").innerHTML =
                "<strong>Uwaga</strong> - Brak danych do wyświetlenia wykresu. Proszę podać daty pomiaru.";
              translatePage(getCookie("lang") || "pl");
              return;
            } else {
              alertBox.style.display = "none";
            }
            let biura = generujNazwyBiur(pietro);

            document.getElementById("myDiv2").innerHTML = "";
            let values = [];

            for (let i = 1; i <= 7; i++) {
              values.push(dane[`l${pietro}_${i}_1`]);
            }
            const labelsNames = biura.map((key) => parsedCookie[key] || key);
            //const sensorNames = czujniki.map(key => parsedCookie[key] || key);

            const data = [
              {
                values: values,
                labels: labelsNames,
                type: "pie",
                hole: 0.3, // efekt donut
                name: "Procent udziału we włączonym świetle",
                textinfo: "label+percent",

                textposition: "inside",
                marker: {
                  line: {
                    color: "#ffffff",
                    width: 2,
                  },
                },
                hoverinfo: "label+percent",
              },
            ];

            const layout = {
              paper_bgcolor: "rgb(211, 226, 236,)", // tło całego wykresu
              plot_bgcolor: "rgb(211, 226, 236,)", // tło obszaru wykresu

              title: {
                text: "Procent udziału we włączonym świetle",
                font: {
                  size: 18,
                },
              },
              height: 450,
              width: 550,
              margin: { t: 30, b: 30, l: 30, r: 30 },
              uniformtext: {
                minsize: 12,
                mode: "hide",
              },
            };

            Plotly.newPlot("myDiv2", data, layout, { responsive: true });
          });
      }

      const heatmapInstance = h337.create({
        container: document.querySelector(".heatmap"),
        radius: 80,
        blur: 0.9,
        maxOpacity: 0.7,
        minOpacity: 0,
        gradient: {
          0: "#f7fbff",
          0.25: "#c6dbef",
          0.5: "#6baed6",
          0.75: "#2171b5",
          1: "#08306b",
        },
      });

      function generujHeatmape(endpoint) {
        const czujniki = generujNazwyCzujnikow(pietro);
        fetch(endpoint)
          .then((res) => res.json())
          .then((dane) => {
            let points = [];
            const cords = [
              [142, 198],
              [550, 217],
              [758, 216],
              [144, 535],
              [377, 537],
              [557, 537],
              [760, 537],
            ];
            let j = 0,
              max = 0;

            for (let i = 0; i < czujniki.length; i += 2) {
              const point = {
                x: cords[j][0],
                y: cords[j][1],
                value: dane[czujniki[i]],
                radius: 80,
              };
              points.push(point);
              if (max < dane[czujniki[i]]) max = dane[czujniki[i]];
              if (j < cords.length - 1) j++;
            }

            heatmapInstance.setData({
              min: 0,
              max: max === 0 ? 100 : max,
              data: points,
            });
          });
      }

      function toLocalISOString(date = new Date()) {
        const pad = (n) => String(n).padStart(2, "0");
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(
          date.getDate()
        )}T${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(
          date.getSeconds()
        )}`;
      }
      function getCookie(name) {
        let cname = name + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i].trim();
          if (c.indexOf(cname) == 0) {
            return c.substring(cname.length, c.length);
          }
        }
        return "";
      }
      function generujWykres(endpoint) {
        const czujniki = generujNazwyCzujnikow(pietro);
        fetch(endpoint)
          .then((res) => res.json())
          .then((dane) => {
            const container = document.getElementById("myPlot");
            container.innerHTML = "";

            if (!cookie) {
              console.error("Brak ciasteczka dla piętra: " + pietro);
              return;
            }
            console.log(cookie);
            //console.log("Cookie JSON PARSE: ", JSON.stringify(JSON.parse(cookie).l1_1));

            const sensorNames = czujniki.map((key) => parsedCookie[key] || key);

            const sensorColors = [
              "Black",
              "Black",
              "Green",
              "Green",
              "Orange",
              "Orange",
              "Yellow",
              "Yellow",
              "Pink",
              "Pink",
              "Blue",
              "Blue",
              "Red",
              "Red",
            ];

            for (let i = 0; i < czujniki.length; i++) {
              const sensorKey = czujniki[i];
              const plotDiv = document.createElement("div");
              plotDiv.id = "plotSensor" + (i + 1);
              plotDiv.className = "plotSensor";
              // plotDiv.style.width = "48%";
              plotDiv.style.margin = "1%";
              plotDiv.style.height = "400px";
              plotDiv.style.float = "left";
              plotDiv.style.marginBottom = "20px";
              container.appendChild(plotDiv);

              const trace = {
                x: dane["data"],
                y: dane[sensorKey],
                mode: "lines",
                name: sensorNames[i],
                line: { shape: "hv", color: sensorColors[i] },
                fill: "tonexty",
              };

              const layout = {
                paper_bgcolor: "rgb(252 252 252)", // tło całego wykresu rgb(211 226 236)
                plot_bgcolor: "rgb(252 252 252)", // tło obszaru wykresu
                title: {
                  text: sensorNames[i],
                  font: { size: 24, color: "#333" },
                },
                xaxis: { title: "Oś X" },
                yaxis: { title: "Oś Y" },
              };

              Plotly.newPlot(plotDiv.id, [trace], layout, { responsive: true });
            }
          });
      }
    </script>
    <script src="../js/dark_mode.js"></script>
  </body>
</html>
